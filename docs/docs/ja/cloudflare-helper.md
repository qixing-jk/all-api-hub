# Cloudflare シールドアシスタント

> Cloudflare 5秒チャレンジ（またはより厳格なBot Fight Mode）を有効にしているアグリゲート中継ステーション向け。プラグインがアカウント情報を認識し、リクエストが制限された際に自動的に再試行できるようにします。

## 機能概要

-   **自動検出**：ページタイトルに `Just a moment` が含まれている、`#cf-content` が存在する、またはAPIが401/403/429などのステータスコードを返した場合に、自動的にシールド突破プロセスをトリガーします。
-   **一時ウィンドウ**：バックグラウンドでターゲットドメインと同一オリジンの仮タブを開き、ブラウザのCookieを継承し、CloudflareのJS/人間認証チャレンジを完了した後に元のページに戻ります。
-   **リクエストのフォールバック**：通常の `fetch` が失敗した場合、一時ウィンドウがCookieを携行してリクエストを再送信し、クロスオリジン/資格情報不足による無限リトライを回避します。
-   **手動フォールバック**：Cloudflareがユーザーインタラクションが必要と判断した場合、自動的にポップアップウィンドウで20秒以内に認証を完了するよう通知します。

## 使用手順

1.  **ターゲットサイトにログイン**し、プラグインでアカウントを追加 → サイトアドレスを入力 → 「自動識別」をクリックします。
2.  Cloudflareのプロンプトが表示された場合、ブラウザが自動的にポップアップ表示します。ウィンドウをフォアグラウンドに保ち、自動認証完了を待つか、指示に従って選択するだけです。
3.  認証が成功すると、プラグインは自動的に識別プロセスに戻り、アクセストークン、残高、モデルリストなどのデータの読み取りを続行します。
4.  APIリクエスト段階でレート制限がトリガーされた場合（CC Switch/CherryStudioのエクスポートまたはNew APIの同期でよく発生）、システムは自動的に一時ウィンドウを有効にして再送信します。追加の操作は不要です。

## 注意事項

-   **IP品質**：連続して通過できない場合、ネットワークを変更するか、サイト側で一時的に保護を緩和する必要があります。デフォルトのタイムアウト時間は20秒です。
-   **ポップアップ権限**：ブラウザのポップアップウィンドウを許可してください。許可しないと、プラグインは一時タブを作成できません。
-   **繰り返しチャレンジ**：頻繁に429がトリガーされる場合、New APIチャネル管理でレートを下げたり、モデルのホワイトリストを有効にしたりして、無効なリクエストを減らします。

## よくある質問

| シナリオ | 解決策 |
|----------|----------|
| ポップアップがすぐに閉じる | ブラウザのアドレスバー右側でポップアップがブロックされていないか確認し、許可してから再識別してください。 |
| 「Just a moment」のまま停止する | ポップアップウィンドウで手動で認証コードを完了します。それでも失敗する場合は、IPを変更してください。 |
| APIエクスポートでまだ403エラーが発生する | 「再度エクスポート」を手動でクリックします。バックグラウンドで、シールドを通過したばかりのCookieが再利用されます。失敗する場合は、ターゲットサイトが管理者トークンを制限していないか確認してください。 |
| ポップアップなしで識別失敗 | サイトがCloudflareを削除した可能性がありますが、APIが401（資格情報が無効）を返します。サイトに再ログインし、プラグインデータを更新してください。 |

## 関連ドキュメント

-   [Cloudflare保護と一時ウィンドウのフォールバック（クイックスタート）](./get-started.md#cloudflare-window-downgrade)
-   [サイトのクイックエクスポート](./quick-export.md)
-   [New APIチャネル管理](./new-api-channel-management.md)
-   [権限管理（オプション権限）](./permissions.md)