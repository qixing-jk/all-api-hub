# New API モデルリスト同期

New API 管理者向けの自動化機能で、すべてのチャネルのモデルリストを自動的に同期し、上流のプロバイダーとの一貫性を保ち、手動での個別更新を不要にします。

![モデルリスト同期インターフェース](../static/image/new-api-channel-sync.png)

## 機能概要

**主な機能**:
- 🔄 **自動同期**: 設定された間隔で、すべてのチャネルのモデルリスト同期を自動的に実行します。
- 🎯 **柔軟な制御**: 全同期、選択的同期、または失敗した項目のみの再試行をサポートします。
- ⚡ **インテリジェントなレート制限**: トークンバケットアルゴリズムを内蔵し、APIレート制限のトリガーを回避します。
- 🔁 **自動再試行**: 失敗したタスクは自動的に再試行され、同期の成功率が向上します。
- 📊 **リアルタイム進捗**: 同期プロセス中にリアルタイムの進捗と詳細な統計を表示します。
- 📜 **履歴**: 完全な実行履歴と結果フィルタリング機能。

**対象**: New API サイト管理者

## 前提条件

この機能を使用する前に、**基本設定** ページで以下の設定を完了する必要があります。

| 設定項目 | 説明 | 取得方法 |
|--------|------|----------|
| **New API ベースURL** | あなたの New API サイトアドレス | 例: `https://your-site.com` |
| **管理者トークン** | Admin Token | New API 管理画面 → 設定 → トークン管理 |
| **ユーザーID** | 管理者ユーザーID | New API 管理画面 → ユーザー管理 |

::: warning 注意
上記情報が設定されていない場合、モデル同期機能は使用できません。設定完了後、**設定 → New API 統合設定** で **「実行と結果を表示」** をクリックすると同期ページにアクセスできます。
:::

## 使用方法

**機能ページへのアクセス**:
1. **設定 → 基本設定** に移動します。
2. **New API 統合設定** セクションを見つけます。
3. **「実行と結果を表示」** ボタンをクリックします。

**手動同期オプション**:

| 操作 | 説明 | 適用シナリオ |
|------|------|----------|
| **すべて実行** | すべてのチャネルのモデルリストを同期します | 初めて使用する場合、または全体的な更新が必要な場合 |
| **選択したものを実行** | チェックしたチャネルのみを同期します | 特定のチャネルを更新する場合 |
| **失敗した項目のみ再試行** | 前回失敗したチャネルを再実行します | ネットワーク問題の修正後の迅速なリカバリ |
| **結果を更新** | 実行履歴を再読み込みします | 最新の同期ステータスを確認する場合 |

**結果の表示とフィルタリング**:
- **ステータスフィルタリング**: **「すべて」** / **「成功」** / **「失敗」** をクリックして表示を切り替えます。
- **検索機能**: チャネル名、ID、またはエラー情報による検索をサポートします。
- **詳細情報**: 各チャネルの古いモデルリスト、新しいモデルリスト、HTTPステータスコード、エラー情報などを表形式で表示します。
- **個別再試行**: 操作列の **「このチャネルを同期」** をクリックすると、個別のチャネルを再同期できます。

**統計カードの説明**:
- **チャネル総数**: 今回の同期に関わるチャネルの数。
- **成功数**: 同期に成功したチャネルの数。
- **失敗数**: 同期に失敗したチャネルの数。
- **所要時間**: 今回の同期の合計時間。
- **次回の予定時刻**: 自動同期が有効な場合に次回の実行時刻を表示します。

## 設定オプション

**設定 → 基本設定 → New API 統合設定** で以下のオプションを設定できます。

| 設定項目 | デフォルト値 | 推奨範囲 | 説明 |
|--------|--------|----------|------|
| **自動同期を有効にする** | オフ | - | 設定された間隔で同期を自動実行します |
| **実行間隔** | 6時間 | 1-24時間 | 自動同期の時間間隔 |
| **同時実行数** | 2 | 1-3 | 同時に処理するチャネルの数。高すぎるとレート制限をトリガーするのを避けます。 |
| **最大再試行回数** | 3 | 2-5 | 失敗時の自動再試行回数 |
| **1分あたりのリクエスト数** | 20 | 10-30 | APIレート制限。サーバーのパフォーマンスに応じて調整します。 |
| **バーストリクエスト上限** | 5 | 3-10 | トークンバケット容量。短時間のバーストリクエストを許可します。 |

**ベストプラクティスの推奨事項**:
1. **同時実行数**: サーバーに過度な負荷をかけないよう、1〜3に設定することをお勧めします。
2. **実行間隔**: モデルの更新頻度に応じて選択し、通常は6〜12時間で十分です。
3. **レート制限**: 頻繁に429エラーが発生する場合は、「1分あたりのリクエスト数」を減らしてください。
4. **再試行ポリシー**: 一時的なネットワーク問題に対処するには、デフォルトの3回の再試行で十分です。

::: tip パフォーマンス最適化
- チャネル数が多い（50以上）場合は、同時実行数を1〜2に減らすことをお勧めします。
- サーバーのパフォーマンスが良い場合は、「1分あたりのリクエスト数」を30まで適切に増やすことができます。
- 自動同期を有効にした後は、頻繁に手動でトリガーする必要はありません。
:::

## よくある質問

**同期に失敗した場合、どうすればよいですか？**

エラー情報に基づいて適切な対策を講じてください。

| エラータイプ | 考えられる原因 | 解決策 |
|----------|----------|----------|
| **設定の欠落** | New API 設定が完了していません | ベースURL、トークン、ユーザーIDが正しく入力されているか確認してください |
| **401 未認証** | 管理者トークンが無効です | Admin Token を再取得し、設定を更新してください |
| **429 レート制限** | リクエストが頻繁すぎます | 「1分あたりのリクエスト数」または「同時実行数」を減らしてください |
| **500 サーバーエラー** | New API サービスが異常です | New API サービスの状態を確認し、後で再試行してください |
| **ネットワークタイムアウト** | ネットワーク接続が不安定です | ネットワーク接続を確認し、「失敗した項目のみ再試行」を使用してください |

**同期結果の理解方法**:

- **古いモデルリスト**: 同期前のチャネルのモデル設定。
- **新しいモデルリスト**: 上流から取得した最新のモデルリスト。
- **HTTPステータスコード**: APIリクエストの応答ステータス（200は成功を示します）。
- **試行回数**: 再試行を含む合計実行回数。

**パフォーマンスに関する考慮事項**:

- 初回同期時やチャネル数が多い場合は時間がかかることがありますが、これは正常な現象です。
- サーバーの負荷が低い時間帯に大規模な同期を実行することをお勧めします。
- 自動同期はバックグラウンドでサイレントに実行され、他の機能の使用には影響しません。

**注意事項**:

::: warning 重要
- 同期操作は New API チャネルのモデルリスト設定を直接変更します。
- 同期を実行する前に、重要な設定をバックアップしていることを確認してください。
- まずテスト環境で同期効果を検証することをお勧めします。
- 頻繁な同期はサーバーのパフォーマンスに影響を与える可能性があるため、実行間隔を適切に設定してください。
:::