# New API 模型列表同步

针对 New API 管理员的自动化功能,能够自动同步所有渠道的模型列表,确保与上游供应商保持一致,无需手动逐个更新。

![模型列表同步界面](./static/image/new-api-channel-sync.png)

## 功能概述

**主要功能**:
- 🔄 **自动同步**: 按设定间隔自动执行所有渠道的模型列表同步
- 🎯 **灵活控制**: 支持全部同步、选择性同步或仅重试失败项
- ⚡ **智能限流**: 内置令牌桶算法,避免触发 API 速率限制
- 🔁 **自动重试**: 失败任务自动重试,提高同步成功率
- 📊 **实时进度**: 同步过程中显示实时进度和详细统计
- 📜 **历史记录**: 完整的执行历史和结果筛选功能

**适用对象**: New API 站点管理员

## 前置要求

使用此功能前,需要在 **基础设置** 页面完成以下配置:

| 配置项 | 说明 | 获取方式 |
|--------|------|----------|
| **New API 基础 URL** | 您的 New API 站点地址 | 例如: `https://your-site.com` |
| **管理员令牌** | Admin Token | New API 后台 → 设置 → 令牌管理 |
| **用户 ID** | 管理员用户 ID | New API 后台 → 用户管理 |

::: warning 注意
未配置以上信息时,将无法使用模型同步功能。配置完成后可在 **设置 → New API 集成设置** 中点击 **"查看执行与结果"** 进入同步页面。
:::

## 使用方法

**访问功能页面**:
1. 进入 **设置 → 基础设置**
2. 找到 **New API 集成设置** 部分
3. 点击 **"查看执行与结果"** 按钮

**手动同步选项**:

| 操作 | 说明 | 适用场景 |
|------|------|----------|
| **执行全部** | 同步所有渠道的模型列表 | 首次使用或需要全面更新 |
| **执行所选** | 仅同步勾选的渠道 | 针对特定渠道更新 |
| **仅重试失败项** | 重新执行上次失败的渠道 | 修复网络问题后快速补救 |
| **刷新结果** | 重新加载执行历史 | 查看最新同步状态 |

**查看和筛选结果**:
- **状态筛选**: 点击 **"全部"** / **"成功"** / **"失败"** 切换显示
- **搜索功能**: 支持按渠道名称、ID 或错误信息搜索
- **详细信息**: 表格显示每个渠道的旧模型列表、新模型列表、HTTP 状态码、错误信息等
- **单独重试**: 点击操作列的 **"同步此渠道"** 可针对单个渠道重新同步

**统计卡片说明**:
- **渠道总数**: 本次同步涉及的渠道数量
- **成功数量**: 成功同步的渠道数
- **失败数量**: 同步失败的渠道数
- **耗时**: 本次同步的总时长
- **下次计划时间**: 启用自动同步时显示下次执行时间

## 配置选项

在 **设置 → 基础设置 → New API 集成设置** 中可配置以下选项:

| 配置项 | 默认值 | 推荐范围 | 说明 |
|--------|--------|----------|------|
| **启用自动同步** | 关闭 | - | 按设定间隔自动执行同步 |
| **执行间隔** | 6 小时 | 1-24 小时 | 自动同步的时间间隔 |
| **并发数量** | 2 | 1-3 | 同时处理的渠道数,避免过高触发限流 |
| **最大重试次数** | 3 | 2-5 | 失败时的自动重试次数 |
| **每分钟请求数** | 20 | 10-30 | API 速率限制,根据服务器性能调整 |
| **突发请求上限** | 5 | 3-10 | 令牌桶容量,允许短时间突发请求 |

**最佳实践建议**:
1. **并发数量**: 建议设置为 1-3,避免对服务器造成过大压力
2. **执行间隔**: 根据模型更新频率选择,一般 6-12 小时即可
3. **速率限制**: 如果遇到频繁的 429 错误,降低"每分钟请求数"
4. **重试策略**: 保持默认的 3 次重试,足以应对临时网络问题

::: tip 性能优化
- 渠道数量较多(>50)时,建议降低并发数至 1-2
- 如果服务器性能较好,可适当提高"每分钟请求数"至 30
- 启用自动同步后,无需频繁手动触发
:::

## 常见问题

**同步失败怎么办?**

根据错误信息采取对应措施:

| 错误类型 | 可能原因 | 解决方案 |
|----------|----------|----------|
| **配置缺失** | 未完成 New API 配置 | 检查基础 URL、令牌和用户 ID 是否正确填写 |
| **401 未授权** | 管理员令牌无效 | 重新获取 Admin Token 并更新配置 |
| **429 速率限制** | 请求过于频繁 | 降低"每分钟请求数"或"并发数量" |
| **500 服务器错误** | New API 服务异常 | 检查 New API 服务状态,稍后重试 |
| **网络超时** | 网络连接不稳定 | 检查网络连接,使用"仅重试失败项" |

**如何理解同步结果?**

- **旧模型列表**: 同步前渠道的模型配置
- **新模型列表**: 从上游获取的最新模型列表
- **HTTP 状态码**: API 请求的响应状态(200 表示成功)
- **尝试次数**: 包含重试在内的总执行次数

**性能考虑**:

- 首次同步或渠道数量多时可能耗时较长,这是正常现象
- 建议在服务器负载较低的时段执行大规模同步
- 自动同步会在后台静默执行,不影响其他功能使用

**注意事项**:

::: warning 重要提示
- 同步操作会直接修改 New API 渠道的模型列表配置
- 请确保已备份重要配置后再执行同步
- 建议先在测试环境验证同步效果
- 频繁同步可能影响服务器性能,合理设置执行间隔
:::